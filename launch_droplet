# https://www.digitalocean.com/community/tutorials/how-to-use-doctl-the-official-digitalocean-command-line-client
# wget https://github.com/digitalocean/doctl/releases/download/v1.7.0/doctl-1.7.0-linux-amd64.tar.gz
# tar xf doctl-*
# mv doctl ~/.scripts
# doctl auth init
# export DIGITALOCEAN_SSH_FINGERPRINTS=d0:e8:09:c3:ef:17:28:74:bf:8c:48:f8:da:a2:5a:ff

if [ -z "$DIGITALOCEAN_SSH_FINGERPRINTS" ]; then
    echo Expected DIGITALOCEAN_SSH_FINGERPRINTS
    exit 1
fi

echo Securing credentials...
# ssh-agent bash
ssh-add

echo Creating droplet...
DROPLET_JSON=$(doctl compute droplet create machine-`date +%Y%m%d-%H%M` --image 26041969 --region nyc1 --size 1gb --ssh-keys $DIGITALOCEAN_SSH_FINGERPRINTS --output json --wait)
echo DROPLET_JSON=$DROPLET_JSON
DROPLET_ID=$(echo $DROPLET_JSON | jq '.[0]["id"]')
if [ -z "$DROPLET_ID" ]; then
    exit 1
fi
echo DROPLET_ID=$DROPLET_ID
echo

echo Getting ip address...
DROPLET_IP_ADDRESS=$(doctl compute droplet get $DROPLET_ID --format PublicIPv4 --no-header)
if [ -z "$DROPLET_IP_ADDRESS" ]; then
    exit 1
fi
echo DROPLET_IP_ADDRESS=$DROPLET_IP_ADDRESS
